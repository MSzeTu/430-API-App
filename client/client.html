<!DOCTYPE html>
<html lang="en">

<head>
  <title>Our simple HTTP server</title>
  <link rel="stylesheet" type="text/css" href="/style.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
  <script type="text/babel">

    let guests = 0; //Variable to track the number of guests
    let guestList = [];
    let rsvpList = [];

    //Handles requests
    const handleResponse = (xhr, parseResponse) => {
      const content = document.querySelector('#content'); //Access the HTML content
      let obj = '';
      switch (xhr.status) { //Act based on status code.
        case 200: //if success
          obj = parseJSON(xhr, content)
          console.log(obj);
          content.innerHTML = `<b>${obj.name} on ${obj.date}</b>`;
          genTable(obj.guests, obj.rsvpd);
          break;
        case 201: //if created, add it to the list
          //Add the event to the list of existing events
          let events = document.querySelector('#eventField');
          let option = document.createElement('OPTION');
          option.innerHTML = document.querySelector('#nameField').value;
          option.value = document.querySelector('#nameField').value;
          events.options.add(option);
          content.innerHTML = `<b>Event has been Created</b>`;
          break;
        case 204: //if already exists
          content.innerHTML = `<b>Updated (No Content)</b>`;
          parseResponse = false; //Do not parse this was a HEAD.
          break;
        case 400: //Bad request
          obj = parseJSON(xhr, content)
          //Print json to console
          content.innerHTML = `<b>${obj.message}</b>`;
          break;
        case 404:
          content.innerHTML = `<b>Page Not Found</b>`;
          break;
      }

      /*if (parseResponse) { //Only Parse non-Heads
        const obj = parseJSON(xhr, content)
        //Print json to console
        console.dir(obj);
        content.innerHTML = obj.message;
      } */
    };

    //Parses the JSON when called
    const parseJSON = (xhr, content) => {
      const obj = JSON.parse(xhr.response);

      return obj;
    };

    //Function for Get Requests. 
    const getRequest = (e, eventForm) => {
      //Grab url
      let url = eventForm.getAttribute('action');

      //Build the URL as necessary
      let selection = document.querySelector('#eventField');
      let name = selection.options[selection.selectedIndex].value;
      url += `?name=${name}`;

      //Grab method
      const method = eventForm.getAttribute('method');

      //Create Ajax request
      const xhr = new XMLHttpRequest();
      xhr.open(method, url);
      xhr.setRequestHeader('Accept', 'application.json');

      //if get or head
      xhr.onload = () => handleResponse(xhr, true);



      //send ajax request
      xhr.send();

      //cancel default
      e.preventDefault(e);
      return false;
    }

    //Function for Post Requests
    const sendPost = (e, nameForm, guests, guestList) => {
      //Set up the guestList
      for (let i = 0; i <= guests; i++) {
        let value = document.querySelector('#nameForm').querySelector(`#guest${i}`).value;
        guestList.push(value);

        let rsvpValue = value = document.querySelector('#nameForm').querySelector(`#rsvp${i}`).checked;
        rsvpList.push(rsvpValue);
      }

      const nameAction = nameForm.getAttribute('action');
      const nameMethod = nameForm.getAttribute('method');


      const nameField = nameForm.querySelector('#nameField');
      const dateField = nameForm.querySelector('#dateField');

      //Create Ajax request
      const xhr = new XMLHttpRequest();

      //Sets ethod and url
      xhr.open(nameMethod, nameAction);

      xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
      xhr.setRequestHeader('Accept', 'application/json');

      xhr.onload = () => handleResponse(xhr, true);


      const formData = `name=${nameField.value}&date=${dateField.value}&guestNum=${guests}&guestList=${guestList}&rsvp=${rsvpList}`;
      console.log(formData);
      xhr.send(formData);

      guestList.splice(0, guestList.length);
      rsvpList.splice(0, rsvpList.length);

      e.preventDefault();
      return false; //Prevents page change
    };


    const add = () => { //Adds a guest input slot
      guests++;
      //Append guest list
      let nameForm = document.querySelector("#nameForm");
      let input = document.createElement("input");
      input.setAttribute('type', 'text');
      input.setAttribute('id', `guest${guests}`);
      input.setAttribute('name', `guest${guests}`);
      nameForm.appendChild(document.createElement("br"));
      nameForm.appendChild(input);

      //Append Checkbox for RSVP
      input = document.createElement("input");
      input.setAttribute('type', 'checkbox');
      input.setAttribute('id', `rsvp${guests}`);
      input.setAttribute('name', `rsvp${guests}`);
      nameForm.appendChild(input);
    }

    const remove = () => { //Removes a guest input slot
      if (guests === 0) {
        return;
      }

      let nameForm = document.querySelector("#nameForm");

      let breaks = document.getElementsByTagName("br");
      nameForm.removeChild(breaks[breaks.length - 1]);

      let removeNode = nameForm.querySelector(`#guest${guests}`);
      nameForm.removeChild(removeNode);

      removeNode = nameForm.querySelector(`#rsvp${guests}`);
      nameForm.removeChild(removeNode);

      guests--;

    }

    //Makes an event Table and puts it in content
    const genTable = (guests, rsvpd) => {
      let body = document.querySelector('#content');

      //Create a table element and tbody element
      let tbl = document.createElement("table");
      let tblBody = document.createElement('tbody');

      //Create the label cells
      let row = document.createElement('tr');
      let cell = document.createElement('td');
      let cellText = document.createElement('b');
      cellText.innerHTML = 'Guests';
      cell.appendChild(cellText);
      row.appendChild(cell);

      cell = document.createElement('td');
      cellText = document.createElement('b');
      cellText.innerHTML = `RSVP'd`;
      cell.appendChild(cellText);
      row.appendChild(cell);

      tblBody.appendChild(row);
      //Populate the rest of the cells
      for (let i = 0; i < guests.length; i++) {
        row = document.createElement('tr');
        cell = document.createElement('td');
        cellText = document.createTextNode(guests[i]);
        cell.appendChild(cellText);
        row.appendChild(cell);

        cell = document.createElement('td');
        if (rsvpd[i] === `true`) {
          cellText = document.createTextNode(`Yes`);
        } else {
          cellText = document.createTextNode(`No`);
        }

        cell.appendChild(cellText);
        row.appendChild(cell);

        tblBody.appendChild(row);
      }

      tbl.appendChild(tblBody);
      body.appendChild(tbl);
      tbl.setAttribute('border', 2);
    }

    const init = () => { //Initializes the page
      const nameForm = document.querySelector('#nameForm');

      //Create handler for addEvent
      const addEvent = (e) => sendPost(e, nameForm, guests, guestList);


      //Sets up the button functionality
      const addButton = document.querySelector('#addButton');
      const removeButton = document.querySelector('#removeButton');
      addButton.addEventListener("click", add);
      removeButton.addEventListener("click", remove);


      nameForm.addEventListener('submit', addEvent);

      //Create handler for getEvent
      const eventForm = document.querySelector('#eventForm');
      const getEvent = (e) => getRequest(e, eventForm);
      eventForm.addEventListener('submit', getEvent);
    }
    window.onload = init;
  </script>
</head>

<body>
  <section id="top">
    <h3>Event and Guest Tracker</h3>
    <form id="nameForm" action="/addEvent" method="post">
      <label for="eventName">Event Name: </label>
      <input id="nameField" type="text" name="eventName" />
      <label for="eventDate">Event Date: </label>
      <input id="dateField" type="date" name="date" />
      <input type="submit" value="Add Event" />
      <br>
      <label for="guests">Guests:</label>
      &emsp;&emsp;&emsp;
      <label for="rsvp">RSVP'd?:</label>
      <br>
      <input type="text" name="guest0" id="guest0">
      <input type="checkbox" name="rsvp0" id="rsvp0">
    </form>
    <button id="addButton">Add Guest</button>
    <button id="removeButton">Remove Guest</button>

    <h3>Retrieve Events Here</h3>
    <form id="eventForm" action="/getEvent" method="get">
      <select id='eventField'>
        <option value='/getEvent'>Event Name</option>
      </select>
      <input type="submit" value="Get Event" />
    </form>
  </section>
  <section id="content">
  </section>
</body>

</html>

<!--References https://stackoverflow.com/questions/6394473/variable-number-of-input-fields-in-form

https://stackoverflow.com/questions/38795210/how-to-create-a-form-with-a-variable-number-of-inputs

-->